name: steam
version: '1.0.0.61'
summary: Launcher for the Steam software distribution service
description: |
 Steam is a software distribution service with an online store, automated
 installation, automatic updates, achievements, SteamCloud synchronized
 savegame and screenshot functionality, and many social features.

grade: stable
confinement: devmode
architectures:
  - build-on: amd64

passthrough:
  # Modern snapcraft can not build against unknown base snaps, so hide
  # this in passthrough so that legacy snapcraft is used.
  base: steamos
  layout:
    /usr/share/themes:
      bind: $SNAP/share/themes
    /usr/share/icons:
      bind: $SNAP/share/icons
    /usr/share/sounds:
      bind: $SNAP/share/sounds
    /usr/lib/steam:
      bind: $SNAP/lib/steam

plugs:
  gtk-3-themes:
    interface: content
    target: $SNAP/share/themes
    default-provider: gtk-common-themes
  icon-themes:
    interface: content
    target: $SNAP/share/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/share/sounds
    default-provider: gtk-common-themes
  steam-library:
    interface: personal-files
    write:
      - $HOME/.local/share/Steam
      - $HOME/Steam

parts:
  launcher:
    plugin: nil
    source : ./src
    override-build: |
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/themes
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/icons
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/sounds
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp steam-snap.sh $SNAPCRAFT_PART_INSTALL/bin

  steam:
    plugin: nil
    source: http://repo.steampowered.com/steam/pool/steam/s/steam/steam-launcher_$SNAPCRAFT_PROJECT_VERSION_all.deb
    override-build: |
      # Copy the binaries and data
      cp -a usr/bin $SNAPCRAFT_PART_INSTALL/bin
      cp -a usr/lib $SNAPCRAFT_PART_INSTALL/lib
      # Copy over the icon
      cp usr/share/icons/hicolor/256x256/apps/steam.png $SNAPCRAFT_PART_INSTALL/steam.png
      mkdir -p $SNAPCRAFT_PART_INSTALL/meta/gui
      ln -s ../../steam.png $SNAPCRAFT_PART_INSTALL/meta/gui/icon.png
      # Install the desktop file, with the icon field munged
      sed 's|Icon=steam|Icon=$SNAP/steam.png|g' usr/share/applications/steam.desktop > $SNAPCRAFT_PART_INSTALL/steam.desktop

apps:
  steam:
    command: steam-snap.sh
    desktop: steam.desktop
    environment:
      HOME: $SNAP_USER_COMMON
      LIBGL_DEBUG: verbose
    plugs:
      - network
      - desktop
      - x11
      - wayland
      - opengl
